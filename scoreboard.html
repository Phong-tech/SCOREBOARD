#!/bin/bash

SCOREBOARD_FILE="/tmp/scoreboard.txt"

echo "Content-type: text/html"
echo ""

# If a POST request is received, update the scoreboard file
if [ "$REQUEST_METHOD" == "POST" ]; then
    read POST_DATA
    USERNAME=$(echo "$POST_DATA" | sed -n 's/^.*username=\([^&]*\).*$/\1/p')
    RESULT=$(echo "$POST_DATA" | sed -n 's/^.*result=\([^&]*\).*$/\1/p')

    awk -F: -v user="$USERNAME" -v result="$RESULT" '
    BEGIN {updated = 0}
    {
        if ($1 == user) {
            $2++; result == "WIN" ? $3++ : $4++;
            updated = 1;
        }
        print $0
    }
    END {
        if (!updated) {
            print user ":1:" (result == "WIN" ? "1:0" : "0:1")
        }
    }' "$SCOREBOARD_FILE" > "${SCOREBOARD_FILE}.tmp" && mv "${SCOREBOARD_FILE}.tmp" "$SCOREBOARD_FILE"
    exit
fi

# Generate dynamic scoreboard rows
SCOREBOARD_ROWS=$(awk -F: '{
    printf "<tr><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>\n", $1, $2, $3, $4
}' "$SCOREBOARD_FILE")

# Read and replace the placeholder in index.html
cat index.html | sed "s/{{SCOREBOARD_DATA}}/$SCOREBOARD_ROWS/"
